---
import Layout from "../layouts/Layout.astro";
import StarExplosion from "../components/StarExplosion.astro";
import ContentReveal from "../components/ui/ContentReveal.astro";
import SearchBar from "../components/ui/SearchBar.astro";
import TagList from "../components/ui/TagList.astro";
import CategoryFilter from "../components/ui/CategoryFilter.astro";
import CyclingLogo from "../components/CyclingLogo.astro";
import FeatureLinks from "../components/FeatureLinks.astro";
import LampTooltip from "../components/LampTooltip.astro";
import { getCollection } from "astro:content";

// Load posts from content collections and sort by date (newest first)
const posts = (await getCollection("posts")).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Get unique categories for filter
const categories = ['tech', 'activism', 'starscape', 'site log', 'random thoughts', 'short stories'];

// Define category colors
const categoryColors = {
  'site log': '#89c9b8',
  'tech': '#f2933d',
  'starscape': '#006600',
  'activism': '#ef4444',
  'random thoughts': '#f093fb',
  'short stories': '#8b5cf6'
};
---

<Layout title="Home">
  <StarExplosion />

  <ContentReveal id="homeContent" class="content">
    <header class="hero">
      <div class="hero-header">
        <div class="title-row">
          <CyclingLogo />
          <h1 class="hero-title animate-title-delayed" id="heroTitle">
            Starlove's lil world
          </h1>
        </div>
        <div class="hero-content animate-content-slow" id="heroContent">
          <div class="hero-text">
            <p>
              Welcome to my corner of webspace where I tinker with creative
              ideas and share thoughts on <strong>technology</strong>, <strong
                id="lampWord"
                class="lamp-trigger">stuff</strong
              >, and <strong>life</strong>.
            </p>
            <p>
              Here you'll find some of my oc, curated shares, project updates
              and reflections. Version 1.0 start small //
            </p>
          </div>

          <FeatureLinks />
        </div>

        <div class="animate-content-extra-slow">
          <SearchBar placeholder="Search posts..." id="searchInput" />
          <CategoryFilter categories={categories} categoryColors={categoryColors} />

          <div class="posts-list" id="postsList">
            {
              posts.map((post) => (
                <article
                  class="post-item"
                  style={`--post-color: ${post.data.color}`}
                  data-tags={post.data.tags.join(", ").toLowerCase()}
                  data-title={post.data.title.toLowerCase()}
                  data-excerpt={post.data.excerpt.toLowerCase()}
                  data-categories={post.data.categories.join(", ").toLowerCase()}
                >
                  <a href={`/blog/${post.slug}`} class="item-link">
                    <div
                      class="item-star"
                      style={`background-color: ${post.data.color}`}
                    >
                      â˜…
                    </div>
                    <div class="item-content">
                      <h3 class="item-title">{post.data.title}</h3>
                      <p class="item-description">{post.data.excerpt}</p>
                      <TagList tags={post.data.tags} />
                    </div>
                  </a>
                </article>
              ))
            }
          </div>
        </div>
      </div>
    </header>

    <LampTooltip />

    <script>
      // Handle star explosion completion
      document.addEventListener("starExplosionComplete", () => {
        const cyberBg = document.querySelector(".cyber-bg");
        const taskbar = document.querySelector(".taskbar");
        if (cyberBg) cyberBg.classList.add("loaded");
        if (taskbar) taskbar.classList.add("reveal");
      });

      // Check on page load if we should reveal immediately (for View Transitions)
      document.addEventListener("astro:page-load", () => {
        const hasPlayed = sessionStorage.getItem("starExplosionPlayed");
        if (hasPlayed) {
          const cyberBg = document.querySelector(".cyber-bg");
          const taskbar = document.querySelector(".taskbar");

          if (cyberBg && !cyberBg.classList.contains("loaded"))
            cyberBg.classList.add("loaded");
          if (taskbar && !taskbar.classList.contains("reveal"))
            taskbar.classList.add("reveal");
        }
      });

      // Fallback reveal in case event doesn't fire
      setTimeout(() => {
        const cyberBg = document.querySelector(".cyber-bg");
        const taskbar = document.querySelector(".taskbar");

        if (cyberBg && !cyberBg.classList.contains("loaded"))
          cyberBg.classList.add("loaded");
        if (taskbar && !taskbar.classList.contains("reveal"))
          taskbar.classList.add("reveal");
      }, 3000);

      let currentCategory = "all";
      let currentSearchQuery = "";

      // Setup search and category filtering
      function setupFilters() {
        const searchInput = document.getElementById(
          "searchInput"
        ) as HTMLInputElement;
        const categoryButtons = document.querySelectorAll(".category-btn");

        if (!searchInput) {
          console.log("Search input not found, skipping setup");
          return;
        }

        console.log("Setting up filters...");

        // Remove any existing listeners by cloning the input
        const newSearchInput = searchInput.cloneNode(true) as HTMLInputElement;
        searchInput.parentNode?.replaceChild(newSearchInput, searchInput);

        // Add the search listener
        newSearchInput.addEventListener("input", (e) => {
          currentSearchQuery = (e.target as HTMLInputElement).value
            .toLowerCase()
            .trim();
          filterPosts();
        });

        // Add category filter listeners
        categoryButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            // Remove active class from all buttons
            categoryButtons.forEach((b) => b.classList.remove("active"));
            // Add active class to clicked button
            btn.classList.add("active");
            
            currentCategory = btn.getAttribute("data-category") || "all";
            filterPosts();
          });
        });

        console.log("Filters setup complete");
      }

      function filterPosts() {
        const allPosts = document.querySelectorAll(
          ".post-item"
        ) as NodeListOf<HTMLElement>;
        let visibleCount = 0;

        allPosts.forEach((post) => {
          const title = post.getAttribute("data-title") || "";
          const excerpt = post.getAttribute("data-excerpt") || "";
          const tags = post.getAttribute("data-tags") || "";
          const categories = post.getAttribute("data-categories") || "";

          const searchMatches =
            currentSearchQuery === "" ||
            title.includes(currentSearchQuery) ||
            excerpt.includes(currentSearchQuery) ||
            tags.includes(currentSearchQuery);

          const categoryMatches =
            currentCategory === "all" ||
            categories.includes(currentCategory);

          const shouldShow = searchMatches && categoryMatches;
          post.style.display = shouldShow ? "flex" : "none";

          if (shouldShow) visibleCount++;
        });

        console.log(`Showing ${visibleCount} out of ${allPosts.length} posts`);
      }

      // Initialize filters
      document.addEventListener("DOMContentLoaded", setupFilters);
      document.addEventListener("astro:after-swap", () =>
        setTimeout(setupFilters, 100)
      );
      document.addEventListener("astro:page-load", () =>
        setTimeout(setupFilters, 100)
      );
    </script>
  </ContentReveal>
</Layout>
